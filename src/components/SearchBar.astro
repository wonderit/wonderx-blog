---
// Search Component - Client-side search (Chirpy-style)
---

<div class="search-wrapper" id="search-wrapper">
  <div class="search-input-wrapper">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input
      type="search"
      id="search-input"
      placeholder="Search..."
      autocomplete="off"
    />
    <button id="search-cancel" class="search-cancel" aria-label="검색 취소">&times;</button>
  </div>
  <div id="search-results" class="search-results"></div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var searchInput = document.getElementById('search-input');
    var searchResults = document.getElementById('search-results');
    var searchCancel = document.getElementById('search-cancel');
    var searchData = null;

    // Fetch search data
    function loadSearchData() {
      if (searchData) return Promise.resolve(searchData);
      return fetch('/search.json')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          searchData = data;
          return data;
        });
    }

    function performSearch(query) {
      if (!query || query.length < 2) {
        searchResults.innerHTML = '';
        searchResults.classList.remove('show');
        return;
      }

      loadSearchData().then(function(data) {
        var q = query.toLowerCase();
        var results = data.filter(function(item) {
          return item.title.toLowerCase().includes(q) ||
                 item.description.toLowerCase().includes(q) ||
                 (item.tags || []).some(function(t) { return t.toLowerCase().includes(q); }) ||
                 (item.category || '').toLowerCase().includes(q);
        });

        if (results.length === 0) {
          searchResults.innerHTML = '<div class="search-no-result">검색 결과가 없습니다.</div>';
        } else {
          searchResults.innerHTML = results.slice(0, 10).map(function(item) {
            return '<a href="' + item.url + '" class="search-result-item">' +
              '<h4>' + highlightMatch(item.title, q) + '</h4>' +
              '<p>' + highlightMatch(item.description, q) + '</p>' +
              '</a>';
          }).join('');
        }
        searchResults.classList.add('show');
      });
    }

    function highlightMatch(text, query) {
      if (!text) return '';
      var idx = text.toLowerCase().indexOf(query);
      if (idx === -1) return text;
      return text.substring(0, idx) +
        '<mark>' + text.substring(idx, idx + query.length) + '</mark>' +
        text.substring(idx + query.length);
    }

    if (searchInput) {
      var debounceTimer;
      searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          performSearch(searchInput.value.trim());
        }, 200);
      });

      searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length >= 2) {
          performSearch(searchInput.value.trim());
        }
      });
    }

    if (searchCancel) {
      searchCancel.addEventListener('click', function() {
        searchInput.value = '';
        searchResults.innerHTML = '';
        searchResults.classList.remove('show');
        searchInput.blur();
      });
    }

    // Click outside to close
    document.addEventListener('click', function(e) {
      var wrapper = document.getElementById('search-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        searchResults.classList.remove('show');
      }
    });
  });
</script>
