---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const CATEGORIES = {
  'ai-automation': { label: 'AI ìë™í™”', icon: 'ğŸ¤–' },
  'side-project': { label: 'ì‚¬ì´ë“œ í”„ë¡œì íŠ¸', icon: 'ğŸš€' },
  'dev-log': { label: 'ê°œë°œ ì¼ì§€', icon: 'ğŸ“' },
  'social': { label: 'ì†Œì…œë§ / ì†Œê°œíŒ…', icon: 'ğŸ’¬' },
  'tutorial': { label: 'íŠœí† ë¦¬ì–¼', icon: 'ğŸ“–' },
} as const;

type CategoryKey = keyof typeof CATEGORIES;

export function getStaticPaths() {
  const cats = ['ai-automation', 'side-project', 'dev-log', 'social', 'tutorial'];
  return cats.map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params as { category: CategoryKey };
const catInfo = CATEGORIES[category];

const posts = (await getCollection('blog'))
  .filter((post) => !post.data.draft && post.data.category === category)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allPosts = (await getCollection('blog')).filter((post) => !post.data.draft);

const allCategories = [
  { id: 'all', label: 'ì „ì²´ ê¸€', icon: 'ğŸ“‹', count: allPosts.length },
  ...Object.entries(CATEGORIES).map(([id, info]) => ({
    id,
    ...info,
    count: allPosts.filter((p) => p.data.category === id).length,
  })),
];
---

<BaseLayout title={`${catInfo.label}`} description={`${catInfo.label} ê´€ë ¨ ê¸€ ëª¨ìŒ â€” WonderX Blog`}>
  <section class="hero">
    <p class="hero-label">{catInfo.icon} {catInfo.label}</p>
    <h1>{catInfo.label}</h1>
    <p>
      {catInfo.label} ê´€ë ¨ ê¸€ {posts.length}ê°œ
    </p>
  </section>

  <div class="content-layout">
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <p class="sidebar-title">ì¹´í…Œê³ ë¦¬</p>
        <ul class="category-list">
          {allCategories.map((cat) => (
            <li>
              <a
                href={cat.id === 'all' ? '/' : `/category/${cat.id}`}
                class:list={['category-link', { active: cat.id === category }]}
              >
                <span class="category-icon">{cat.icon}</span>
                <span class="category-name">{cat.label}</span>
                <span class="category-count">{cat.count}</span>
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>

    <section class="posts-section">
      {posts.length > 0 ? (
        <div class="posts-grid">
          {posts.map((post) => {
            const formattedDate = post.data.pubDate.toLocaleDateString('ko-KR', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            });
            return (
              <a href={`/blog/${post.id}`} class="post-card">
                <div class="post-meta">
                  <time class="post-date" datetime={post.data.pubDate.toISOString()}>
                    {formattedDate}
                  </time>
                  {post.data.tags && (
                    <div class="post-tags">
                      {post.data.tags.map((tag: string) => (
                        <span class="post-tag">{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
                <h2 class="post-title">{post.data.title}</h2>
                <p class="post-excerpt">{post.data.description}</p>
              </a>
            );
          })}
        </div>
      ) : (
        <p style="color: var(--wx-text-secondary); font-family: var(--font-mono); font-size: 0.9rem;">
          ì•„ì§ ì´ ì¹´í…Œê³ ë¦¬ì— ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
      )}
    </section>
  </div>
</BaseLayout>
