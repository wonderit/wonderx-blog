---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PopularPosts from '@/components/PopularPosts.astro';
import RightPanel from '@/components/RightPanel.astro';
import SearchBar from '@/components/SearchBar.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const categoryLabels: Record<string, string> = {
  'ai-automation': 'AI 자동화',
  'side-project': '사이드 프로젝트',
  'dev-log': '개발 일지',
  'social': '소셜링',
  'tutorial': '튜토리얼',
};
---

<BaseLayout title="Blog">
  <SearchBar slot="topbar-right" />

  <div class="home-layout">
    <div class="home-main">
      <!-- Site Stats -->
      <div class="site-stats">
        <span class="stat-item">전체 방문 <strong id="total-views">-</strong></span>
        <span class="stat-divider">·</span>
        <span class="stat-item">오늘 <strong id="today-views">-</strong></span>
      </div>

      <!-- Popular Posts Carousel -->
      <PopularPosts posts={posts} limit={5} />

      <!-- Recent Posts -->
      <section class="posts-section">
        <div class="posts-section-header">
          <h2 class="posts-section-title">최근 글</h2>
        </div>

        {posts.length > 0 ? (
          <div class="posts-grid">
            {posts.map((post) => {
              const slug = post.id.replace(/\.md$/, '');
              const formattedDate = post.data.pubDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
              });
              const catLabel = categoryLabels[post.data.category] || post.data.category || '';
              return (
                <a href={`/blog/${slug}`} class="post-card" data-path={`/blog/${slug}`}>
                  <div class="post-info">
                    <div class="post-info-meta">
                      <time class="post-date" datetime={post.data.pubDate.toISOString()}>
                        {formattedDate}
                      </time>
                      {catLabel && <span class="post-category">{catLabel}</span>}
                      <span class="post-views">-</span>
                    </div>
                    <h2 class="post-title">{post.data.title}</h2>
                    <p class="post-excerpt">{post.data.description}</p>
                  </div>
                  {post.data.heroImage && (
                    <div class="post-thumbnail">
                      <img src={post.data.heroImage} alt={post.data.title} loading="lazy" />
                    </div>
                  )}
                </a>
              );
            })}
          </div>
        ) : (
          <p style="color: var(--text-secondary); font-size: 0.9rem; padding: 2rem 0;">
            아직 작성된 글이 없습니다. 첫 번째 글을 작성해보세요!
          </p>
        )}
      </section>
    </div>

    <!-- Right Panel -->
    <RightPanel posts={posts} />
  </div>
</BaseLayout>

<script is:inline>
  function loadViewCounts() {
    if (!window.goatcounter || !window.goatcounter.visit_count) return false;

    // 전체 방문자수
    window.goatcounter.visit_count({
      append: '#total-views',
      path: 'TOTAL',
      type: 'html',
      no_branding: true,
    });

    // 오늘 방문자수
    var today = new Date().toISOString().slice(0, 10);
    window.goatcounter.visit_count({
      append: '#today-views',
      path: 'TOTAL',
      type: 'html',
      no_branding: true,
      start: today,
    });

    // 각 글별 조회수
    document.querySelectorAll('.post-card[data-path]').forEach(function(card) {
      var postPath = card.getAttribute('data-path');
      var viewsEl = card.querySelector('.post-views');
      if (viewsEl && postPath) {
        window.goatcounter.visit_count({
          append: viewsEl,
          path: postPath,
          type: 'html',
          no_branding: true,
        });
      }
    });
    return true;
  }

  // Goatcounter 스크립트가 async로 로드되므로 retry
  if (!loadViewCounts()) {
    var retries = 0;
    var timer = setInterval(function() {
      if (loadViewCounts() || ++retries > 20) clearInterval(timer);
    }, 500);
  }
</script>

<style>
  .site-stats {
    padding: 1.25rem 0 0;
  }
</style>
