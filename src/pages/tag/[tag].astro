---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const tags = [...new Set(allPosts.flatMap((p) => p.data.tags || []))];
  return tags.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const posts = (await getCollection('blog'))
  .filter((post) => !post.data.draft && post.data.tags?.includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`#${tag}`} description={`${tag} 태그 관련 글 모음 — WonderX Blog`}>
  <section class="hero">
    <h1>#{tag}</h1>
    <p>관련 글 {posts.length}개</p>
  </section>

  <div class="content-layout">
    <section class="posts-section">
      {posts.length > 0 ? (
        <div class="posts-grid">
          {posts.map((post) => {
            const formattedDate = post.data.pubDate.toLocaleDateString('ko-KR', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            });
            return (
              <a href={`/blog/${post.id.replace(/\.md$/, '')}`} class="post-card">
                {post.data.heroImage && (
                  <div class="post-thumbnail">
                    <img src={post.data.heroImage} alt={post.data.title} loading="lazy" />
                  </div>
                )}
                <div class="post-info">
                  <time class="post-date" datetime={post.data.pubDate.toISOString()}>
                    {formattedDate}
                  </time>
                  <h2 class="post-title">{post.data.title}</h2>
                  <p class="post-excerpt">{post.data.description}</p>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <p style="color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.9rem;">
          이 태그에 해당하는 글이 없습니다.
        </p>
      )}
    </section>
  </div>
</BaseLayout>
